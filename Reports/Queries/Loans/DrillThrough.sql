SELECT
	DATA.COD_PROSPETTO,
	CAST(LOAN.RB_ROWID AS VARCHAR(255)) AS RB_ROW_ID,
	LOAN.MONTH_END_DATE,
	LOAN.REPORTING_ENTITY,
	LOAN.INSTRUMENT,
	LOAN.SOURCE,
  	LOAN.INTERCOMPANY,
	LOAN.CALL_CODE,
	LOAN.CALL_CODE_DESC,
	LOAN.BASE_EQUIVALENT,
	LOAN.PROD_GROUP_DESC,
	LOAN.PROD_GROUP_TYPE_DESC,
	LOAN.CUSTOMER_ID,
	LOAN.CUSTOMER_NAME,
	LOAN.CUSTOMER_TYPE,
	LOAN.RELATED_DEP_INST_YESNO,
	LOAN.PURPOSE_CODE,
	LOAN.FOREIGN_DOMESTIC,
	LOAN.CUST_PARENT_FOREIGN_DOMESTIC,
	LOAN.COUNTRY_CODE,
	LOAN.COUNTRY_DESC,
	LOAN.RISK_COUNTRY,
	LOAN.OPERATING_STATE,
	LOAN.LOAN_USED_IN_STATE,
	LOAN.BORROWER_COUNTY,
	LOAN.LOAN_USED_IN_COUNTY,
	LOAN.AFFL_CONSOL_NODE,
	LOAN.DAY_COUNT_BASIS,
	LOAN.HIGHLVL_PROD_CAT,
	LOAN.GL_KEY_CODE,
	LOAN.GL_KEY_CODE_DESC,
	LOAN.PRINCIPAL_GL_US_GAAP_BASE_EQ,
	LOAN.ACC_INT_GL_US_GAAP_BASE_EQ,
	LOAN.DEF_FEES_GL_US_GAAP_BASE_EQ,
	LOAN.UNEARN_FEES_GL_US_GAAP_BASE_EQ,
	LOAN.SPCFC_RESRV_GL_US_GAAP_BASE_EQ,
	LOAN.INT_INC_GL_US_GAAP_BASE_EQ,
	LOAN.FEES_GL_US_GAAP_BASE_EQ,
  LOAN.PRINCIPAL_GL_IFRS_BASE_EQ,
  LOAN.ACC_INT_GL_IFRS_BASE_EQ,
  LOAN.DEFERRED_FEES_GL_IFRS_BASE_EQ,
  LOAN.UNEARNED_FEES_GL_IFRS_BASE_EQ,
  LOAN.SPCFC_RESRV_GL_IFRS_BASE_EQ,
  LOAN.INT_INC_GL_IFRS_BASE_EQ,
  LOAN.FEES_GL_IFRS_BASE_EQ,
  LOAN.UMD1,
  LOAN.UMD2,
  LOAN.UMD3,
  LOAN.CONSOL_NODE,
  LOAN.SUB_LE1,
  LOAN.SUB_LE2,
  LOAN.BUSINESS_UNIT,
  LOAN.BUSINESS_LINE,
  LOAN.CURRENCY_CODE,
  LOAN.LEGAL_CUST_TOTAL_COMMIT,
  LOAN.LEGAL_CUST_PRINC_FUNDED,
  LOAN.LEGAL_CUST_UNFUNDED_COMMIT,
  LOAN.LEGAL_CUST_INT_OWED,
  LOAN.BANK_SHARE_PRINC_IFRS,
  LOAN.BANK_SHARE_PRINC_US_GAAP,
  LOAN.BANK_SHARE_TOTAL_COMMIT,
  LOAN.BANK_SHARE_UNFUNDED_COMMIT,
  LOAN.BANK_SPECIFIC_RESRV_US_GAAP,
  LOAN.UNEARNED_FEES_US_GAAP,
  LOAN.CHARGED_OFF_US_GAAP,
  LOAN.CHARGED_OFF_IFRS,
  LOAN.SPECIFIC_RESRV_IFRS,
  LOAN.NON_ACC_INTEREST_DIFF_US_GAAP,
  LOAN.INTEREST_APPLIED_PRINC_US_GAAP,
  LOAN.NON_ACC_INTEREST_DIFF_IFRS,
  LOAN.INTEREST_APPLLIED_PRINC_IFRS,
  LOAN.UNEARNED_FEE_IFRS,
  LOAN.LEDGER_ACCRUED_INTEREST_IFRS,
  LOAN.LEDG_ACC_INTEREST_US_GAAP,
  LOAN.INTEREST_PL_MTD_IFRS,
  LOAN.INTEREST_PL_MTD_US_GAAP,
  LOAN.INTEREST_PL_QTD_IFRS,
  LOAN.INTEREST_PL_QTD_US_GAAP,
  LOAN.INTEREST_PL_YTD_IFRS,
  LOAN.INTEREST_PL_YTD_US_GAAP,
  LOAN.ORIGINAL_PREMIUM_DISCOUNT,
  LOAN.REMAINING_PREMIUM_DISCOUNT,
  LOAN.ORIGINATION_DATE,
  LOAN.MATURITY_DATE,
  LOAN.ORIGINAL_INTEREST_RATE,
  LOAN.REVOLVER_YN,
  LOAN.RATE_EFFECTIVE_DATE,
  LOAN.RATE_EXPIRATION_DATE,
  LOAN.INTEREST_RATE,
  LOAN.OVER_UNDER_RATE_INDEX,
  LOAN.NOTE_CEILING_RATE,
  LOAN.NOTE_FLOOR_RATE,
  LOAN.NEXT_RATE_RESET_DATE,
  LOAN.LAST_RATE_RESET_DATE,
  LOAN.RATE_RESET_FREQUENCY,
  LOAN.LAST_REPRICING_DATE,
  LOAN.RB_INDEX,
  LOAN.FIXED_OR_VARIABLE,
  LOAN.BOOK_INDICATOR_HTM_OR_AFS,
  LOAN.IF_AFS_THEN_FV_BALANCE,
  LOAN.CUSTOMER_PARENT,
  LOAN.AMORTIZATION_METHOD,
  LOAN.COF_FTP_RATE,
  LOAN.SPREAD,
  LOAN.FED_CALL_CODE,
  LOAN.ZIP_CODE,
  LOAN.REAL_ESTATE_ZIP_CODE,
  LOAN.PCT_OWNED,
  LOAN.MATURITY_REPORTING,
  LOAN.MATURITY_BUCKETS,
  LOAN.PAST_DUE_YN,
  LOAN.NUMBER_OF_DAYS_PAST_DUE,
  LOAN.RB_SECURED_DE,
  LOAN.RB_ACCTG_METD_DESC,
  LOAN.NON_ACCRUAL_YN,
  LOAN.DATE_NON_ACCRUAL,
  LOAN.TDR_YN,
  LOAN.DATE_TDR,
  LOAN.TDR_COMP_WITH_MOD_TERMS_YN,
  LOAN.TDR_TYPE,
  LOAN.GOVT_GUARANTEED_AGENCY,
  LOAN.GOVT_GUARANTEED_PERCENTAGE,
  LOAN.US_GAAP_RISK_RATING,
  LOAN.IFRS_RISK_RATING,
  LOAN.IN_PROCESS_OF_FORECLOSURE,
  LOAN.ACQUIRED_IN_BUS_COMBINATION_YN,
  LOAN.SOP03_3_ACCTNG_TREATMENT_YN,
  LOAN.FV_LN_ACQ_IN_BUS_COMB_AT_ACQSN,
  LOAN.GROSS_CNTRCT_AMT_REC_AT_ACQSN,
  LOAN.ESTCNTRCL_CSFLW_NOEXPCTD2BCLTD,
  LOAN.SYNDICATED_PARTICIPATED_LOAN,
  LOAN.AGENT_PARTICIPANT,
  LOAN.PORTION_OF_SYNDICATED_LOAN_HFS,
  LOAN.UMD_3,
  LOAN.UMD_4,
  LOAN.UMD_5,
  LOAN.CO_BORROWER_ID,
  LOAN.CO_BORROWER_NAME,
  LOAN.RELATIONSHIP_MANAGER_NAME,
  LOAN.NAICS_CODE,
  LOAN.NAICS_DESC,
  LOAN.INDUSTRIES,
  LOAN.RAPID_COLLATERAL_TYPE,
  LOAN.FAC_LEVEL_LINK,
  LOAN.RB_FAC_NAME,
  LOAN.FACILITY_BORROWER_CIF,
  LOAN.FACILITY_BORROWER_NAME,
  LOAN.FACILITY_TRADE_ID,
  LOAN.FAC_OUTSTANDING_AVAILABLE_AMT,
  LOAN.FACILITY_LIMIT_AMOUNT,
  LOAN.FACILITY_USED_AMOUNT,
  LOAN.FACILITY_ORIGINAL_CURRENCY,
  LOAN.FAC_OUTSTANDING_GL_ORI_CUR_AMT,
  LOAN.FACILITY_START_DATE,
  LOAN.FACILITY_END_DATE,
  LOAN.LENDER_TYPE_DESC,
  LOAN.GLOBAL_SECTOR,
  LOAN.LOCAL_SECTOR,
  LOAN.REGULATORY_RISK_RATING,
  LOAN.VARIABLE_INTEREST_ENTITY,
  LOAN.UMD_7,
  LOAN.UMD_8,
  LOAN.UMD_9,
  LOAN.TRADE_ID,
  LOAN.PROD_GROUP,
  LOAN.ACBS_LENDER_TYPE,
  LOAN.FED_CALL_CODE2,
  LOAN.RESCOUNTRY_OF_CUSTOMER,
  LOAN.CIF_TYPE,
  LOAN.CIF_DESCRIPTION_PHOENIX,
  LOAN.CODE_OF_PARENT_PHOENIX,
  LOAN.DESC_OF_PARENT_PHOENIX,
  LOAN.RESCOUNTRY_OF_PARENT,
  LOAN.PORTFOLIO,
  LOAN.PRODUCT_TYPE,
  LOAN.IS_REPORTABLE_LOAN_YN,
  LOAN.BU,
  LOAN.ACCOUNT,
  LOAN.PRODUCT,
  LOAN.OPERATING_UNIT,
  LOAN.DEPTID,
  LOAN.AFFILIATE,
  LOAN.OBU_AFFILIATE,
  LOAN.CUST_CLASS,
  LOAN.CODEBLOCK,
  LOAN.DEFERRED_CODEBLOCK,
  LOAN.RESERVE_CODEBLOCK,
  LOAN.DESCRIPTION,
	${CONCATENATE($Account.attribute5, " [", $Account.attribute4, "]", " - ", PARENT($Account(HIERARCHY("RE"))).desc)} AS LINE_ITEM
FROM
  RB_DRILL_INSTRUMENT DRILL
  INNER JOIN
  FORM_DATI DATA
  ON
    DRILL.OID_FORM_DATI = DATA.OID_FORM_DATI
  INNER JOIN
  RB_V_LOAN LOAN
  ON
    DATA.DATA_1 = LOAN.MONTH_END_DATE
    AND DATA.TESTO_1 = LOAN.REPORTING_ENTITY
    AND DATA.TESTO_49 = CAST(LOAN.RB_ROWID AS VARCHAR(255))
WHERE
  DRILL.COD_SCENARIO IN (${$Scenario.code})
  AND DRILL.COD_PERIODO IN (${$Period.code})
  AND DRILL.COD_AZIENDA IN (${$Entity.code})
  AND DRILL.COD_CONTO IN (${$Account.code})
  AND DRILL.COD_DEST1 IN (${$Cust_Dim1.code})
  AND DRILL.COD_DEST2 IN (${$Cust_Dim2.code})
  AND DRILL.COD_DEST3 IN (${$Cust_Dim3.code})
  AND DRILL.COD_DEST4 IN (${$Cust_Dim4.code})
  AND DRILL.COD_DEST5 IN (${$Cust_Dim5.code})
  AND DRILL.COD_CATEGORIA IN (${$Category.code})
UNION ALL
SELECT
	'ADJUSTMENTS' AS COD_TAPE,
	DATA.NUM_RETTIFICA AS RB_ROWID,
	SP.DATA_FINE AS MONTH_END_DATE,
	NULL AS REPORTING_ENTITY,
	NULL AS INSTRUMENT,
	A.NOTE AS SOURCE,
	NULL AS INTERCOMPANY,
	NULL AS CALL_CODE,
	NULL AS CALL_CODE_DESC,
	DATA.IMPORTO2 * 1000 AS BASE_EQUIVALENT,
	NULL AS PROD_GROUP_DESC,
	NULL AS PROD_GROUP_TYPE_DESC,
	NULL AS CUSTOMER_ID,
	NULL AS CUSTOMER_NAME,
	NULL AS CUSTOMER_TYPE,
	NULL AS RELATED_DEP_INST_YESNO,
	NULL AS PURPOSE_CODE,
	NULL AS FOREIGN_DOMESTIC,
	NULL AS CUST_PARENT_FOREIGN_DOMESTIC,
	NULL AS COUNTRY_CODE,
	NULL AS COUNTRY_DESC,
	NULL AS RISK_COUNTRY,
	NULL AS OPERATING_STATE,
	NULL AS LOAN_USED_IN_STATE,
	NULL AS BORROWER_COUNTY,
	NULL AS LOAN_USED_IN_COUNTY,
	NULL AS AFFL_CONSOL_NODE,
	NULL AS DAY_COUNT_BASIS,
	NULL AS HIGHLVL_PROD_CAT,
	NULL AS GL_KEY_CODE,
	NULL AS GL_KEY_CODE_DESC,
	NULL AS PRINCIPAL_GL_US_GAAP_BASE_EQ,
	NULL AS ACC_INT_GL_US_GAAP_BASE_EQ,
	NULL AS DEF_FEES_GL_US_GAAP_BASE_EQ,
	NULL AS UNEARN_FEES_GL_US_GAAP_BASE_EQ,
	NULL AS SPCFC_RESRV_GL_US_GAAP_BASE_EQ,
	NULL AS INT_INC_GL_US_GAAP_BASE_EQ,
	NULL AS FEES_GL_US_GAAP_BASE_EQ,
  NULL AS PRINCIPAL_GL_IFRS_BASE_EQ,
  NULL AS ACC_INT_GL_IFRS_BASE_EQ,
  NULL AS DEFERRED_FEES_GL_IFRS_BASE_EQ,
  NULL AS UNEARNED_FEES_GL_IFRS_BASE_EQ,
  NULL AS SPCFC_RESRV_GL_IFRS_BASE_EQ,
  NULL AS INT_INC_GL_IFRS_BASE_EQ,
  NULL AS FEES_GL_IFRS_BASE_EQ,
  NULL AS UMD1,
  NULL AS UMD2,
  NULL AS UMD3,
  NULL AS CONSOL_NODE,
  NULL AS SUB_LE1,
  NULL AS SUB_LE2,
	DATA.COD_AZIENDA AS BUSINESS_UNIT,
  NULL AS BUSINESS_LINE,
	DATA.COD_VALUTA2 AS CURRENCY_CODE,
	NULL AS LEGAL_CUST_TOTAL_COMMIT,
  NULL AS LEGAL_CUST_PRINC_FUNDED,
  NULL AS LEGAL_CUST_UNFUNDED_COMMIT,
  NULL AS LEGAL_CUST_INT_OWED,
  NULL AS BANK_SHARE_PRINC_IFRS,
  NULL AS BANK_SHARE_PRINC_US_GAAP,
  NULL AS BANK_SHARE_TOTAL_COMMIT,
  NULL AS BANK_SHARE_UNFUNDED_COMMIT,
  NULL AS BANK_SPECIFIC_RESRV_US_GAAP,
  NULL AS UNEARNED_FEES_US_GAAP,
  NULL AS CHARGED_OFF_US_GAAP,
  NULL AS CHARGED_OFF_IFRS,
  NULL AS SPECIFIC_RESRV_IFRS,
  NULL AS NON_ACC_INTEREST_DIFF_US_GAAP,
  NULL AS INTEREST_APPLIED_PRINC_US_GAAP,
  NULL AS NON_ACC_INTEREST_DIFF_IFRS,
  NULL AS INTEREST_APPLLIED_PRINC_IFRS,
  NULL AS UNEARNED_FEE_IFRS,
  NULL AS LEDGER_ACCRUED_INTEREST_IFRS,
  NULL AS LEDG_ACC_INTEREST_US_GAAP,
  NULL AS INTEREST_PL_MTD_IFRS,
  NULL AS INTEREST_PL_MTD_US_GAAP,
  NULL AS INTEREST_PL_QTD_IFRS,
  NULL AS INTEREST_PL_QTD_US_GAAP,
  NULL AS INTEREST_PL_YTD_IFRS,
  NULL AS INTEREST_PL_YTD_US_GAAP,
  NULL AS ORIGINAL_PREMIUM_DISCOUNT,
  NULL AS REMAINING_PREMIUM_DISCOUNT,
  NULL AS ORIGINATION_DATE,
  NULL AS MATURITY_DATE,
  NULL AS ORIGINAL_INTEREST_RATE,
  NULL AS REVOLVER_YN,
  NULL AS RATE_EFFECTIVE_DATE,
  NULL AS RATE_EXPIRATION_DATE,
  NULL AS INTEREST_RATE,
  NULL AS OVER_UNDER_RATE_INDEX,
  NULL AS NOTE_CEILING_RATE,
  NULL AS NOTE_FLOOR_RATE,
  NULL AS NEXT_RATE_RESET_DATE,
  NULL AS LAST_RATE_RESET_DATE,
  NULL AS RATE_RESET_FREQUENCY,
  NULL AS LAST_REPRICING_DATE,
  NULL AS RB_INDEX,
  NULL AS FIXED_OR_VARIABLE,
  NULL AS BOOK_INDICATOR_HTM_OR_AFS,
  NULL AS IF_AFS_THEN_FV_BALANCE,
  NULL AS CUSTOMER_PARENT,
  NULL AS AMORTIZATION_METHOD,
  NULL AS COF_FTP_RATE,
  NULL AS SPREAD,
  NULL AS FED_CALL_CODE,
  NULL AS ZIP_CODE,
  NULL AS REAL_ESTATE_ZIP_CODE,
  NULL AS PCT_OWNED,
  NULL AS MATURITY_REPORTING,
  NULL AS MATURITY_BUCKETS,
  NULL AS PAST_DUE_YN,
  NULL AS NUMBER_OF_DAYS_PAST_DUE,
  NULL AS RB_SECURED_DE,
  NULL AS RB_ACCTG_METD_DESC,
  NULL AS NON_ACCRUAL_YN,
  NULL AS DATE_NON_ACCRUAL,
  NULL AS TDR_YN,
  NULL AS DATE_TDR,
  NULL AS TDR_COMP_WITH_MOD_TERMS_YN,
  NULL AS TDR_TYPE,
  NULL AS GOVT_GUARANTEED_AGENCY,
  NULL AS GOVT_GUARANTEED_PERCENTAGE,
  NULL AS US_GAAP_RISK_RATING,
  NULL AS IFRS_RISK_RATING,
  NULL AS IN_PROCESS_OF_FORECLOSURE,
  NULL AS ACQUIRED_IN_BUS_COMBINATION_YN,
  NULL AS SOP03_3_ACCTNG_TREATMENT_YN,
  NULL AS FV_LN_ACQ_IN_BUS_COMB_AT_ACQSN,
  NULL AS GROSS_CNTRCT_AMT_REC_AT_ACQSN,
  NULL AS ESTCNTRCL_CSFLW_NOEXPCTD2BCLTD,
  NULL AS SYNDICATED_PARTICIPATED_LOAN,
  NULL AS AGENT_PARTICIPANT,
  NULL AS PORTION_OF_SYNDICATED_LOAN_HFS,
  NULL AS UMD_3,
  NULL AS UMD_4,
  NULL AS UMD_5,
  NULL AS CO_BORROWER_ID,
  NULL AS CO_BORROWER_NAME,
  NULL AS RELATIONSHIP_MANAGER_NAME,
  NULL AS NAICS_CODE,
  NULL AS NAICS_DESC,
  NULL AS INDUSTRIES,
  NULL AS RAPID_COLLATERAL_TYPE,
  NULL AS FAC_LEVEL_LINK,
  NULL AS RB_FAC_NAME,
  NULL AS FACILITY_BORROWER_CIF,
  NULL AS FACILITY_BORROWER_NAME,
  NULL AS FACILITY_TRADE_ID,
  NULL AS FAC_OUTSTANDING_AVAILABLE_AMT,
  NULL AS FACILITY_LIMIT_AMOUNT,
  NULL AS FACILITY_USED_AMOUNT,
  NULL AS FACILITY_ORIGINAL_CURRENCY,
  NULL AS FAC_OUTSTANDING_GL_ORI_CUR_AMT,
  NULL AS FACILITY_START_DATE,
  NULL AS FACILITY_END_DATE,
  NULL AS LENDER_TYPE_DESC,
  NULL AS GLOBAL_SECTOR,
  NULL AS LOCAL_SECTOR,
  NULL AS REGULATORY_RISK_RATING,
  NULL AS VARIABLE_INTEREST_ENTITY,
  NULL AS UMD_7,
  NULL AS UMD_8,
  NULL AS UMD_9,
  NULL AS TRADE_ID,
  NULL AS PROD_GROUP,
  NULL AS ACBS_LENDER_TYPE,
  NULL AS FED_CALL_CODE2,
  NULL AS RESCOUNTRY_OF_CUSTOMER,
  NULL AS CIF_TYPE,
  NULL AS CIF_DESCRIPTION_PHOENIX,
  NULL AS CODE_OF_PARENT_PHOENIX,
  NULL AS DESC_OF_PARENT_PHOENIX,
  NULL AS RESCOUNTRY_OF_PARENT,
  NULL AS PORTFOLIO,
  NULL AS PRODUCT_TYPE,
  NULL AS IS_REPORTABLE_LOAN_YN,
  NULL AS BU,
  NULL AS ACCOUNT,
	DATA.COD_DEST3 AS PRODUCT,
	DATA.COD_DEST2 AS OPERATING_UNIT,
  DATA.COD_DEST2 AS DEPTID,
  DATA.COD_AZI_CTP AS AFFILIATE,
  NULL AS OBU_AFFILIATE,
  DATA.COD_DEST4 AS CUST_CLASS,
  NULL AS CODEBLOCK,
  NULL AS DEFERRED_CODEBLOCK,
  NULL AS RESERVE_CODEBLOCK,
  NULL AS DESCRIPTION,
	${CONCATENATE($Account.attribute5, " [", $Account.attribute4, "]", " - ", PARENT($Account(HIERARCHY("RE"))).desc)} AS LINE_ITEM
FROM
	DATI_RETT_RIGA DATA
	LEFT OUTER JOIN
	DATI_RETT A
	ON
		DATA.COD_SCENARIO = A.COD_SCENARIO
		AND DATA.COD_PERIODO = A.COD_PERIODO
		AND DATA.NUM_RETTIFICA = A.NUM_RETTIFICA
	LEFT OUTER JOIN
	SCENARIO_PERIODO SP
	ON
		DATA.COD_SCENARIO = SP.COD_SCENARIO
		AND DATA.COD_PERIODO = SP.COD_PERIODO
WHERE
  DATA.COD_SCENARIO IN (${$Scenario.code}) 
  AND DATA.COD_PERIODO IN (${$Period.code})
  AND DATA.COD_AZIENDA IN (${$Entity.code})
  AND DATA.COD_CONTO IN (${$Account.code})
  AND DATA.COD_DEST1 IN (${$Cust_Dim1.code})
  AND DATA.COD_DEST2 IN (${$Cust_Dim2.code})
  AND DATA.COD_DEST3 IN (${$Cust_Dim3.code})
  AND DATA.COD_DEST4 IN (${$Cust_Dim4.code})
  AND DATA.COD_DEST5 IN (${$Cust_Dim5.code})
  AND DATA.COD_CATEGORIA IN (${$Category.code})